{
  "id": "PRD-011",
  "title": "Visual Diff",
  "type": "feature",
  "status": "complete",
  "description": "Transform the structured diff data from PRD-010's compare endpoint into human-readable, cell-level visual comparisons. Enables actuaries to see exactly which values changed between any two versions of an assumption table.",
  "dependencies": [
    "PRD-010: Assumption Table Versioning (compare endpoint)"
  ],
  "userStories": [
    {
      "id": "US-001",
      "title": "Get formatted diff",
      "description": "As an analyst, I want to retrieve a human-readable diff between two versions so I can quickly understand what changed",
      "acceptanceCriteria": [
        "GET /tables/{id}/versions/diff?v1={a}&v2={b} returns formatted diff",
        "Response includes version metadata (who created, when, comments)",
        "Diff organized by change type: added rows, removed rows, modified cells",
        "Modified cells show: row_index, column_name, old_value, new_value",
        "Summary stats included: total_changes, rows_added, rows_removed, cells_modified"
      ],
      "priority": 1,
      "passes": true
    },
    {
      "id": "US-002",
      "title": "Column-level diff summary",
      "description": "As an analyst, I want to see which columns had changes so I can focus my review on affected areas",
      "acceptanceCriteria": [
        "Diff response includes column_summary array",
        "Each column entry shows: column_name, change_count, has_additions, has_removals, has_modifications",
        "Columns with no changes are omitted or marked as unchanged"
      ],
      "priority": 2,
      "passes": true
    },
    {
      "id": "US-003",
      "title": "Row-level change markers",
      "description": "As an analyst, I want to see the full context of changed rows, not just the changed cells",
      "acceptanceCriteria": [
        "Modified rows include all cell values, not just changed ones",
        "Each cell in a modified row marked as: unchanged, modified, added, or removed",
        "Enables side-by-side comparison UI in future frontend"
      ],
      "priority": 3,
      "passes": true
    },
    {
      "id": "US-004",
      "title": "Filter diff by column",
      "description": "As an analyst, I want to filter the diff to specific columns when reviewing large tables",
      "acceptanceCriteria": [
        "Optional query param: columns=col1,col2,col3",
        "When provided, diff only includes changes to specified columns",
        "Summary stats reflect filtered view",
        "Returns 400 if invalid column name provided"
      ],
      "priority": 4,
      "passes": true
    },
    {
      "id": "US-005",
      "title": "Filter diff by row range",
      "description": "As an analyst, I want to filter the diff to a specific row range for large tables",
      "acceptanceCriteria": [
        "Optional query params: row_start, row_end",
        "When provided, diff only includes rows within range (inclusive)",
        "Can combine with column filter",
        "Summary stats reflect filtered view"
      ],
      "priority": 5,
      "passes": true
    },
    {
      "id": "US-006",
      "title": "Export diff to CSV",
      "description": "As an analyst, I want to export the diff as a CSV for offline review or audit documentation",
      "acceptanceCriteria": [
        "GET /tables/{id}/versions/diff/export?v1={a}&v2={b}&format=csv",
        "CSV includes: row_index, column_name, old_value, new_value, change_type",
        "Respects column/row filters if provided",
        "Content-Disposition header triggers download",
        "Filename includes table name and version numbers"
      ],
      "priority": 6,
      "passes": true
    }
  ],
  "technicalNotes": {
    "diffStructure": {
      "description": "Response format for diff endpoint",
      "example": {
        "table_id": "uuid",
        "version_a": {
          "id": "uuid",
          "version_number": 2,
          "created_by": "uuid",
          "created_at": "iso",
          "comment": "Q2 update"
        },
        "version_b": {
          "id": "uuid",
          "version_number": 7,
          "created_by": "uuid",
          "created_at": "iso",
          "comment": "Q3 mortality revision"
        },
        "summary": {
          "total_changes": 47,
          "rows_added": 3,
          "rows_removed": 1,
          "cells_modified": 43
        },
        "column_summary": [
          {
            "column_name": "mortality_rate",
            "change_count": 35,
            "has_modifications": true
          },
          {
            "column_name": "age_band",
            "change_count": 0,
            "has_modifications": false
          }
        ],
        "changes": [
          {
            "type": "row_added",
            "row_index": 156,
            "cells": {
              "age_band": "95-99",
              "mortality_rate": "0.32145"
            }
          },
          {
            "type": "row_modified",
            "row_index": 42,
            "cells": [
              {
                "column_name": "mortality_rate",
                "old_value": "0.00234",
                "new_value": "0.00251",
                "status": "modified"
              },
              {
                "column_name": "age_band",
                "value": "40-44",
                "status": "unchanged"
              }
            ]
          }
        ]
      }
    },
    "performanceConsiderations": "For tables with 10k+ rows and many versions, diff computation should happen server-side with pagination support. Consider caching diff results for frequently compared version pairs.",
    "buildingOnPRD010": "PRD-010's compare endpoint returns raw diff structure. This PRD adds: formatting, filtering, column summaries, and CSV export."
  },
  "definitionOfDone": [
    "All six user stories implemented and tested",
    "Diff endpoint returns structured, documented response format",
    "Filtering works correctly for columns and row ranges",
    "CSV export generates valid, downloadable files",
    "Performance acceptable for 10k row tables",
    "API documented in /docs"
  ],
  "futureEnhancements": [
    "Frontend UI with side-by-side visual comparison",
    "Highlighted cells in table view",
    "Diff annotations (comments on specific changes)",
    "Diff approval workflow (sign-off on reviewed changes)",
    "PDF export for audit documentation"
  ]
}
