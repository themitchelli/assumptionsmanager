{
  "type": "feature",
  "project": "Assumptions Manager",
  "id": "PRD-012",
  "name": "Approval Workflow",
  "description": "Governance workflow enabling assumption table versions to move through draft → submitted → approved/rejected states. Provides audit trail for regulatory compliance and prevents unapproved assumptions from being used in production models. This is the 'protected main' concept from Git - only admins can approve, and approval history is immutable.",
  "dependsOn": [
    "PRD-010"
  ],
  "architectureNotes": {
    "extractability": "Approval logic lives in backend/services/approvals/ with clear interfaces. Uses same entity-agnostic pattern as versioning for future Model Manager extraction.",
    "auditTrail": "All state transitions logged with timestamp, user, and optional comment. History is append-only - no edits or deletes.",
    "permissions": [
      "viewer: can view approval status and history",
      "analyst: can submit versions for approval",
      "admin: can approve or reject submissions"
    ]
  },
  "dataModel": {
    "version_approvals": {
      "description": "Tracks approval state for each version",
      "columns": {
        "id": "UUID, primary key",
        "version_id": "UUID, FK to assumption_versions (unique - one approval record per version)",
        "status": "ENUM: draft, submitted, approved, rejected",
        "submitted_by": "UUID, FK to users (nullable - only set when submitted)",
        "submitted_at": "TIMESTAMP (nullable)",
        "reviewed_by": "UUID, FK to users (nullable - only set when approved/rejected)",
        "reviewed_at": "TIMESTAMP (nullable)",
        "created_at": "TIMESTAMP",
        "updated_at": "TIMESTAMP"
      }
    },
    "approval_history": {
      "description": "Immutable audit log of all approval state changes",
      "columns": {
        "id": "UUID, primary key",
        "version_id": "UUID, FK to assumption_versions",
        "from_status": "ENUM: draft, submitted, approved, rejected (nullable for initial creation)",
        "to_status": "ENUM: draft, submitted, approved, rejected",
        "changed_by": "UUID, FK to users",
        "comment": "TEXT (optional - rejection reason, approval note, etc.)",
        "created_at": "TIMESTAMP"
      }
    }
  },
  "stateTransitions": {
    "description": "Valid state transitions for approval workflow",
    "transitions": [
      {
        "from": "draft",
        "to": "submitted",
        "allowedRoles": ["analyst", "admin"],
        "action": "submit_for_approval"
      },
      {
        "from": "submitted",
        "to": "approved",
        "allowedRoles": ["admin"],
        "action": "approve"
      },
      {
        "from": "submitted",
        "to": "rejected",
        "allowedRoles": ["admin"],
        "action": "reject"
      },
      {
        "from": "rejected",
        "to": "submitted",
        "allowedRoles": ["analyst", "admin"],
        "action": "resubmit",
        "note": "Allows resubmission after addressing feedback"
      },
      {
        "from": "approved",
        "to": null,
        "allowedRoles": [],
        "action": null,
        "note": "Approved versions are terminal - cannot be changed"
      }
    ]
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "View approval status",
      "description": "As a user, I want to see the approval status of a version so I know if it's safe to use in production",
      "acceptanceCriteria": [
        "GET /tables/{id}/versions/{version_id} includes approval_status in response",
        "Status is one of: draft, submitted, approved, rejected",
        "Response includes submitted_by, submitted_at, reviewed_by, reviewed_at where applicable",
        "New versions default to 'draft' status",
        "All roles can view approval status (viewer, analyst, admin)"
      ],
      "priority": 1,
      "passes": true
    },
    {
      "id": "US-002",
      "title": "Submit version for approval",
      "description": "As an analyst, I want to submit a version for approval so it can be reviewed by an admin",
      "acceptanceCriteria": [
        "POST /tables/{id}/versions/{version_id}/submit transitions status from draft to submitted",
        "Request body optional: { \"comment\": \"Ready for Q3 review\" }",
        "Records submitted_by (current user) and submitted_at timestamp",
        "Creates entry in approval_history with from_status=draft, to_status=submitted",
        "Returns 200 with updated version including new approval status",
        "Returns 400 if version is not in draft status",
        "Returns 403 if user role is viewer",
        "Returns 404 if version or table not found"
      ],
      "priority": 2,
      "passes": true
    },
    {
      "id": "US-003",
      "title": "Approve version",
      "description": "As an admin, I want to approve a submitted version so it can be used in production",
      "acceptanceCriteria": [
        "POST /tables/{id}/versions/{version_id}/approve transitions status from submitted to approved",
        "Request body optional: { \"comment\": \"Verified against source data\" }",
        "Records reviewed_by (current user) and reviewed_at timestamp",
        "Creates entry in approval_history with from_status=submitted, to_status=approved",
        "Returns 200 with updated version including new approval status",
        "Returns 400 if version is not in submitted status",
        "Returns 403 if user role is not admin",
        "Returns 404 if version or table not found"
      ],
      "priority": 3,
      "passes": true
    },
    {
      "id": "US-004",
      "title": "Reject version",
      "description": "As an admin, I want to reject a submitted version with feedback so the analyst can address issues",
      "acceptanceCriteria": [
        "POST /tables/{id}/versions/{version_id}/reject transitions status from submitted to rejected",
        "Request body required: { \"comment\": \"Mortality rates appear incorrect for ages 65+\" }",
        "Comment is required for rejections (helps analyst understand what to fix)",
        "Records reviewed_by (current user) and reviewed_at timestamp",
        "Creates entry in approval_history with from_status=submitted, to_status=rejected",
        "Returns 200 with updated version including new approval status",
        "Returns 400 if version is not in submitted status",
        "Returns 400 if comment is missing or empty",
        "Returns 403 if user role is not admin",
        "Returns 404 if version or table not found"
      ],
      "priority": 4,
      "passes": true
    },
    {
      "id": "US-005",
      "title": "Resubmit rejected version",
      "description": "As an analyst, I want to resubmit a rejected version after making corrections",
      "acceptanceCriteria": [
        "POST /tables/{id}/versions/{version_id}/submit also works for rejected versions",
        "Transitions status from rejected to submitted",
        "Request body optional: { \"comment\": \"Fixed mortality rates per feedback\" }",
        "Updates submitted_by and submitted_at (clears previous reviewed_by/reviewed_at)",
        "Creates entry in approval_history with from_status=rejected, to_status=submitted",
        "Returns 200 with updated version",
        "Returns 400 if version is not in draft or rejected status",
        "Returns 403 if user role is viewer"
      ],
      "priority": 5,
      "passes": true
    },
    {
      "id": "US-006",
      "title": "View approval history",
      "description": "As a user, I want to see the full approval history for a version so I can understand its governance journey",
      "acceptanceCriteria": [
        "GET /tables/{id}/versions/{version_id}/history returns approval_history entries",
        "Each entry includes: id, from_status, to_status, changed_by (with user name), comment, created_at",
        "Ordered by created_at ascending (oldest first - tells the story chronologically)",
        "Returns empty array for versions with no history (newly created draft)",
        "All roles can view history (viewer, analyst, admin)",
        "Returns 404 if version or table not found"
      ],
      "priority": 6,
      "passes": false
    },
    {
      "id": "US-007",
      "title": "Filter versions by approval status",
      "description": "As a user, I want to filter the version list by approval status so I can quickly find approved or pending versions",
      "acceptanceCriteria": [
        "GET /tables/{id}/versions accepts optional query param: ?status=approved",
        "Valid status values: draft, submitted, approved, rejected",
        "Can filter by multiple statuses: ?status=submitted&status=rejected",
        "Without filter, returns all versions (existing behaviour)",
        "Returns empty array if no versions match filter",
        "All roles can use filter"
      ],
      "priority": 7,
      "passes": false
    },
    {
      "id": "US-008",
      "title": "Prevent modification of approved versions",
      "description": "As a system, I want to prevent any modifications to approved versions so the audit trail remains intact",
      "acceptanceCriteria": [
        "DELETE /tables/{id}/versions/{version_id} returns 403 if version is approved",
        "POST /tables/{id}/versions/{version_id}/restore returns 400 if restoring would overwrite data from an approved version (note: restoring TO an approved version is fine)",
        "Approved versions are immutable - no status changes allowed",
        "Error messages clearly explain that approved versions cannot be modified",
        "Admins cannot bypass this protection - approved is terminal"
      ],
      "priority": 8,
      "passes": false
    }
  ],
  "testingNotes": [
    "Test state machine transitions exhaustively - invalid transitions should return 400",
    "Verify approval_history entries are created for every state change",
    "Confirm approved versions truly cannot be deleted or modified",
    "Test role permissions: viewers can't submit, non-admins can't approve/reject",
    "Verify resubmission clears reviewer fields but preserves history"
  ],
  "futureEnhancements": [
    "PRD-016: Email/webhook notifications when versions are submitted, approved, or rejected",
    "Delegation: allow admins to delegate approval authority for specific tables",
    "Batch approval: approve multiple versions at once",
    "Approval expiry: approved versions could require re-approval after N months"
  ]
}
