{
  "type": "feature",
  "project": "Assumptions Manager",
  "id": "PRD-009",
  "name": "Assumption Tables CRUD",
  "description": "Core functionality for creating, reading, updating, and deleting actuarial assumption tables. Uses a rows-based relational model (tables → columns → rows → cells) to enable clean versioning, diffing, and CSV export in future PRDs.",
  "dependsOn": [
    "PRD-007",
    "PRD-008"
  ],
  "dataModel": {
    "assumption_tables": {
      "description": "Top-level table metadata",
      "columns": {
        "id": "UUID, primary key",
        "tenant_id": "UUID, FK to tenants (RLS)",
        "name": "VARCHAR(255), required",
        "description": "TEXT, optional",
        "effective_date": "DATE, optional",
        "created_by": "UUID, FK to users",
        "created_at": "TIMESTAMP",
        "updated_at": "TIMESTAMP"
      }
    },
    "assumption_columns": {
      "description": "Column definitions for each table (flexible schema)",
      "columns": {
        "id": "UUID, primary key",
        "table_id": "UUID, FK to assumption_tables",
        "name": "VARCHAR(100), required",
        "data_type": "ENUM: text, integer, decimal, date, boolean",
        "position": "INTEGER, for column ordering",
        "created_at": "TIMESTAMP"
      }
    },
    "assumption_rows": {
      "description": "Row containers for cell data",
      "columns": {
        "id": "UUID, primary key",
        "table_id": "UUID, FK to assumption_tables",
        "row_index": "INTEGER, for row ordering",
        "created_at": "TIMESTAMP"
      }
    },
    "assumption_cells": {
      "description": "Individual cell values",
      "columns": {
        "id": "UUID, primary key",
        "row_id": "UUID, FK to assumption_rows",
        "column_id": "UUID, FK to assumption_columns",
        "value": "TEXT (stored as text, cast on read based on column data_type)",
        "created_at": "TIMESTAMP"
      }
    }
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "Create assumption table",
      "description": "As an analyst, I want to create a new assumption table with column definitions so I can store actuarial data",
      "acceptanceCriteria": [
        "POST /tables creates a new assumption table",
        "Accepts: name (required), description (optional), effective_date (optional), columns (array)",
        "Each column has: name, data_type, position",
        "Returns created table with id and column definitions",
        "Requires analyst or admin role",
        "tenant_id set from JWT automatically"
      ],
      "priority": 1,
      "passes": true
    },
    {
      "id": "US-002",
      "title": "List assumption tables",
      "description": "As a user, I want to see all assumption tables in my tenant so I can find the one I need",
      "acceptanceCriteria": [
        "GET /tables returns list of tables in current tenant",
        "RLS enforces tenant isolation",
        "Returns: id, name, description, effective_date, created_by, created_at",
        "Does not return row/cell data (metadata only)",
        "All authenticated roles can access (viewer, analyst, admin)"
      ],
      "priority": 2,
      "passes": true
    },
    {
      "id": "US-003",
      "title": "Get assumption table with data",
      "description": "As a user, I want to view a complete assumption table including all rows and cells",
      "acceptanceCriteria": [
        "GET /tables/{id} returns full table data",
        "Includes: metadata, column definitions, all rows with cell values",
        "Cells organized by row, values cast to appropriate types based on column data_type",
        "Returns 404 if table not found or not in user's tenant",
        "All authenticated roles can access"
      ],
      "priority": 3,
      "passes": true
    },
    {
      "id": "US-004",
      "title": "Update table metadata",
      "description": "As an analyst, I want to update a table's name, description, or effective date",
      "acceptanceCriteria": [
        "PATCH /tables/{id} updates metadata fields",
        "Accepts: name, description, effective_date (all optional)",
        "Does not modify columns or row data (separate endpoints)",
        "Returns updated table metadata",
        "Requires analyst or admin role",
        "Returns 404 if not found or not in tenant"
      ],
      "priority": 4,
      "passes": true
    },
    {
      "id": "US-005",
      "title": "Add rows to table",
      "description": "As an analyst, I want to add rows of data to an assumption table",
      "acceptanceCriteria": [
        "POST /tables/{id}/rows adds one or more rows",
        "Accepts array of rows, each row is object with column_name: value pairs",
        "Validates values against column data_types",
        "Returns created rows with ids and cell data",
        "Requires analyst or admin role",
        "Row indices auto-assigned (append to end)"
      ],
      "priority": 5,
      "passes": false
    },
    {
      "id": "US-006",
      "title": "Update row data",
      "description": "As an analyst, I want to update cell values in an existing row",
      "acceptanceCriteria": [
        "PATCH /tables/{table_id}/rows/{row_id} updates cell values",
        "Accepts object with column_name: value pairs (partial update)",
        "Validates values against column data_types",
        "Returns updated row with all cell values",
        "Requires analyst or admin role"
      ],
      "priority": 6,
      "passes": false
    },
    {
      "id": "US-007",
      "title": "Delete rows",
      "description": "As an analyst, I want to delete rows from a table",
      "acceptanceCriteria": [
        "DELETE /tables/{table_id}/rows/{row_id} removes a row and its cells",
        "Returns 204 on success",
        "Requires analyst or admin role",
        "Cascades to delete all cells in the row"
      ],
      "priority": 7,
      "passes": false
    },
    {
      "id": "US-008",
      "title": "Delete assumption table",
      "description": "As an admin, I want to delete an entire assumption table when it's no longer needed",
      "acceptanceCriteria": [
        "DELETE /tables/{id} removes table and all associated data",
        "Cascades: columns, rows, cells all deleted",
        "Returns 204 on success",
        "Requires admin role only (analysts cannot delete tables)",
        "Returns 404 if not found or not in tenant"
      ],
      "priority": 8,
      "passes": false
    }
  ],
  "technicalNotes": {
    "dataTypes": "text (default), integer, decimal (for rates like 0.00234), date, boolean",
    "validation": "Backend validates cell values match column data_type before insert/update",
    "nulls": "Empty cells stored as NULL, not empty string",
    "rls": "assumption_tables has tenant_id; child tables (columns, rows, cells) inherit via joins",
    "indexes": "Index on assumption_tables(tenant_id), assumption_rows(table_id), assumption_cells(row_id, column_id)",
    "responseFormat": "GET /tables/{id} returns nested structure: { table, columns: [], rows: [{ row_index, cells: { column_name: value } }] }"
  },
  "definitionOfDone": [
    "All eight user stories implemented and tested",
    "Database migrations for four new tables",
    "RLS policies on assumption_tables",
    "Data type validation on cell values",
    "Proper role-based access (viewer=read, analyst=read/write, admin=all)",
    "API documented in /docs"
  ]
}